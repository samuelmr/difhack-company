
<!doctype html>
<html>
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="width">
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />
  <title>Secure Chat client</title>
  <style>
    fieldset {
        border-radius: 0.5em;
        max-width: 20em;
    }
    legend {
        background-color: #FFF;
    }
    label, textarea, #messages {
        display: block;
        clear: left;
        float: left;
    }
    input[type="submit"] {
      float: right;
    }
    #messages p, textarea {
        background-color: #FFF;
        border: 1px solid #CCC;
        border-radius: 0.5em;
        margin-left: 10%;
        width: 90%;
    }
    #messages p.other {
        background-color: aqua;
        margin-left: 0;
    }
    label {
        width: 11ex;
    }
  </style>
 </head>
 <body>
  <h1>Secure Chat client</h1>
  <form id="form">
   <fieldset>
    <legend>Chat</legend>
    <label for="to">To:</label> <input id="to" name="to" size="30" placeholder="URL or DID"/>
    <label for="name">Name:</label> <input id="name" name="name" size="30"/>
    <label for="topic">Topic:</label> <input id="topic" name="topic" size="30"/>
     <div id="messages"></div>
     <label for="message">Message:</label>
     <textarea id="message" name="message" cols="30" rows="5"></textarea>
     <input type="submit" name="action" value="Send">
   </fieldset>
  </form>
  <script>

   const msgs = document.getElementById('messages')

   const urlParts = [
    'wss:',
    '',
    document.location.host,
    document.location.pathname.replace(/^\//, '').replace(/\/$/, ''),
    'ws'
   ]
   const url = urlParts.join('/')
   const socket = new WebSocket(url)
   let pingTimer
   function heartbeat() {
    clearTimeout(pingTimer)
    pingTimer = setTimeout(() => {
     socket.send('ping')
    }, 15000)
   }
   socket.addEventListener("open", heartbeat)
   socket.addEventListener("ping", (event) => {
    console.log(event)
    socket.send("pong")
    heartbeat()
   })
   socket.addEventListener("error", (event) => {
    console.log(event)
   })
   socket.addEventListener("message", (event) => {
    const msg = event.data
    console.log(msg)
    if (msg == 'pong') {
     heartbeat()
     return
    }
    const p = document.createElement('p')
    p.className = 'other'
    p.textContent = msg
    msgs.appendChild(p)
   })
   socket.addEventListener("close", (event) => {
    clearTimeout(pingTimer)
   })

   const f = document.getElementById('form')
   f.onsubmit = function(e) {
    e.preventDefault()
    let toPath = this.to.value
      .replace(/^(https?:\/\/)/, '')
      .replace(/\/?$/, '')
      .replace('/', ':')
    const msg = {
     thread: this.topic.value,
     toDid: `did:web:${toPath}`,
     message: this.message.value
    }
    console.log(JSON.stringify(msg))
    socket.send(JSON.stringify(msg))
   }

   const params = new URLSearchParams(document.location.search)
   for (const field of f.elements) {
    if (!field.id) continue
    const value = params.get(field.id)
    if (value) {
      field.value = value
    }
   }

/*
   socket.onmessage((event) => {
    const msg = event.data
    console.log(msg)
    const p = document.createElement('p')
    p.className = 'other'
    p.textContent = msg
    msgs.appendChild(p)
   })
*/
  </script>
 </body>
</html>
